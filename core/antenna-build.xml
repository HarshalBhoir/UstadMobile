<?xml version="1.0" encoding="UTF-8"?>
<!-- 

Ustad Mobile J2ME Ant Build designed to run externally without relying on 
NetBeans.  See README for instructions on building from source.

-->

<project name="UstadMobileCore" default="jar" basedir=".">
    <description>Core Java bits of UstadMobile .</description>
    
    
    <condition property="build.properties.filename" 
        value="ustadmobilecore-build.properties" 
        else="ustadmobilecore-build.default.properties">
            
        <resourceexists>
            <file file="build-release.properties"/>
        </resourceexists>
    </condition>

    <property file="ustadmobilecore-build.properties"/> 
        
    <condition property="classpath.antenna" 
               value="${classpath}"
               else="${antenna.home}">
        <available resource="antenna.properties"/>
    </condition>
    
    <taskdef classpath="${classpath.antenna}" resource="antenna.properties"/>
    
    <!-- properties to make it build outside netbeans -->
    <property name="src.dir" value="./src/"/>
    
    <!--
    <property name="MidletSuite" value="UstadMobileCore"/>
    <property name="Midlet_1_name" value="Ustad Mobile Core"/>
    <property name="Midlet_1_class" value="ustadmobilemicrotest.Midlet"/>
    -->
    
    <property name="wtk.cldc.version" value="1.1"/>
    <property name="wtk.midp.version" value="2.1"/>
    
    <!-- do per version pre-processing -->
    <target name="preprocess">
        
        <!-- end of properties to make it build outside of netbeans -->
        
        <path id="ustadlibclasspath.ref">
            <fileset dir="${lib.dir}" >
      
            </fileset>
        </path>
        
        <path id="ustadlibclasspath.ref">
            <fileset dir="${lib.dir}" >
                <include name="kxml2-min-2.3.0.jar" />
            </fileset>
        </path>

        
        <wtkpreprocess verbose="true"  
           srcdir="${src.dir}" 
            destdir="${src.preprocessed.ANTENNA}"
            device="Antenna"
            version="2"
            symbols="ANTENNA,MEDIAENABLED,CRAZYDEBUG,DEBUGLOG,ERRORLOGTHRESHOLD=0"
            printsymbols="true"
        />


    </target>
            
    <target name="build" depends="preprocess">
        <mkdir dir="${classes.dir.ANTENNA}"/>
                
        <wtkbuild srcdir="${src.preprocessed.ANTENNA}"
            destdir="${classes.dir.ANTENNA}"
            preverify="false" 
            bootclasspath="${wtk.active.bootclasspath}:${classpath.antennaui}"
            classpath="${toString:ustadlibclasspath.ref}">

        </wtkbuild>
    </target>
            
    <target name="jar" depends="build">
        <mkdir dir="${dist.dir.ANTENNA}"/>

        <wtkjad jadfile="${dist.dir.ANTENNA}/${MidletSuite}.jad" 
            jarfile="${dist.dir.ANTENNA}/${MidletSuite}.jar"
            name="Ustad Mobile"
            vendor="Ustad Mobile Inc">

            <midlet name="${Midlet_1_name}" class="${Midlet_1_class}"></midlet>

            <attribute name="MIDlet-Version" value="${ustadmobileversion}"/>

            <attribute name="MicroEdition-Configuration" value="CLDC-1.1"/>
            <attribute name="MicroEdition-Profile" value="MIDP-2.0"/>
            <attribute name="Antenna-MIDlet-Category" value="Application"/>
            <attribute name="MIDlet-Permissions" value="javax.microedition.io.Connector.file.read, javax.microedition.io.Connector.file.write"/>
            <attribute name="MIDlet-Jar-URL" value="${MidletSuite}.jar"/>

            <attribute name="progressive_download" value="enabled"/>


        </wtkjad>


        <echo message="looking for proguard in: ${wtk.proguard.home}/lib/proguard.jar"/>
        <wtkpackage basedir="${classes.dir.ANTENNA}" 
            jarfile="${dist.dir.ANTENNA}/${MidletSuite}.jar"
            jadfile="${dist.dir.ANTENNA}/${MidletSuite}.jad"
            config="CLDC-1.1"
            profile="MIDP-2.0"
            obfuscate="${ustadmobile.obfuscate}"
            preverify="true"
            libclasspath="${toString:ustadlibclasspath.ref}"
            bootclasspath="${wtk.active.bootclasspath}:${wtk.proguard.home}/lib/proguard.jar:${classpath.antennaui}" 
            includes="${javac.includes}">
                <fileset dir="${classes.dir.ANTENNA}"/>

        </wtkpackage>
    </target>

    <target name="clean">
        <delete dir="${src.preprocessed.ANTENNA}"/>
        <delete dir="${classes.dir.ANTENNA}"/>
        <delete dir="${dist.dir.ANTENNA}"/>
    </target>

    <target name="wtk-runme" depends="jar">
        <wtkrun jadfile="${dist.dir.ANTENNA}/${MidletSuite}.jad" device="DefaultColorPhone" wait="true"/>
    </target>
    
    <target name="getlibs">
        <mkdir dir="${lib.dir}"/>
        <mkdir dir="${lib.dir}/downloads"/>

        <get dest="${lib.dir}/downloads">

            <!-- kXML JAR from UstadMobile.com -->
            <url url="http://www.ustadmobile.com/build-dep/kxml2-min-2.3.0.jar"/>

            <!-- microEmu ANTENNA from UstadMobile.com -->
            <url url="http://www.ustadmobile.com/build-dep/microemu-nokiaui.jar"/>

            <!-- ProGuard 4.10 zipped binary from UstadMobile.com -->
            <url url="http://www.ustadmobile.com/build-dep/proguard4.10.zip"/>
        </get>

        <unzip dest="${lib.dir}">
            <fileset dir="${lib.dir}/downloads">
                <include name="*.zip"/>
            </fileset>
        </unzip>

        <copy todir="${lib.dir}">
            <fileset dir="${lib.dir}/downloads">
                <include name="*.jar"/>
            </fileset>
        </copy>
    </target>

</project>

