import java.util.concurrent.atomic.AtomicInteger

/**
 * Core module build script : see buildconfig.core.default.gradle for configuration
 */

buildscript {
    repositories {
        mavenCentral()
        jcenter()
        maven {
            url 'https://plugins.gradle.org/m2/'
        }
    }
    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$version_kotlin"
        classpath "org.jetbrains.kotlin:kotlin-serialization:$version_kotlin"
    }
}


apply plugin: "kotlin-multiplatform"
apply plugin: 'kotlinx-serialization'
apply plugin: 'com.android.library'
apply plugin: "maven-publish"


android {
    compileSdkVersion rootProject.ext.version_android_compile_sdk
    buildToolsVersion rootProject.ext.version_android_buildtools

    defaultConfig {
        minSdkVersion rootProject.ext.version_android_min_sdk
        targetSdkVersion rootProject.ext.version_android_target_sdk
    }
    compileOptions {
        sourceCompatibility = '1.8'
        targetCompatibility = '1.8'
    }
}


kotlin {

    jvm {
        compilations.main.kotlinOptions {
            // Setup the Kotlin compiler options for the 'main' compilation:
            jvmTarget = "$version_kotlin_jvmTarget"
        }
    }


    targets {
        fromPreset(presets.jvm, 'jvm')
        fromPreset(presets.android, 'android')
        fromPreset(presets.js, 'js')
        //Uncomment this for autocomplete etc. to work. Comment it out before compiling the rest of
        // the project to avoid it being seen as an extra jvm variant
        //fromPreset(presets.jvm,'commonJvm') //uncomment for code completion
    }


    sourceSets {
        commonMain {
            dependencies {
                implementation "org.jetbrains.kotlin:kotlin-stdlib-common:$version_kotlin"
                implementation "org.jetbrains.kotlinx:kotlinx-serialization-runtime-common:$version_kotlinx_serialization"
                implementation "com.soywiz:klock-metadata:$version_klock"
                implementation "com.ustadmobile.kmpxmlpullparser:KMPXmlPullParser-metadata:$version_kmp"
                implementation "io.ktor:ktor-client-core:$version_ktor"
                implementation "io.ktor:ktor-client-json:$version_ktor"
                implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core-common:$version_coroutines"
                implementation "com.github.aakira:napier:$version_napier"
                implementation "org.jetbrains.kotlinx:atomicfu-common:$version_atomicfu"
                implementation project(':lib-door-runtime')
                compileOnly project(':lib-database')
                compileOnly project(':lib-database-entities')
                compileOnly project(":lib-room-annotations")
                implementation project(":lib-util")
            }
        }
        commonJvmMain {
            dependencies {
                implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$version_kotlin"
                implementation "io.ktor:ktor-client-okhttp:$version_ktor"
                implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$version_coroutines"
                implementation "com.ustadmobile.kmpxmlpullparser:KMPXmlPullParser-jvm:$version_kmp"
                implementation "org.jetbrains.kotlinx:kotlinx-serialization-runtime:$version_kotlinx_serialization"
                implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:$version_coroutines"
                implementation "org.jetbrains.kotlinx:atomicfu:$version_atomicfu"

            }
        }

        jvmMain {
            dependencies {
                implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$version_coroutines"
                implementation "com.github.aakira:napier-jvm:$version_napier"
                implementation "com.soywiz:klock-jvm:$version_klock"
            }
            dependsOn commonJvmMain
        }

        commonTest {
            dependencies {
                implementation project(":lib-database-mpp")
                implementation project(":lib-database-entities")
                implementation project(":lib-database")
            }
        }

        jvmTest {
            dependencies {
                implementation "junit:junit:$version_junit"
                implementation "com.nhaarman.mockitokotlin2:mockito-kotlin:$version_kotlin_mockito"

                implementation "com.github.h-thurow:simple-jndi:$version_simple_jndi"
                implementation "org.apache.commons:commons-pool2:$version_apache_commons_pool2"
                implementation "org.xerial:sqlite-jdbc:$version_sqlite_jdbc"
                implementation "org.apache.commons:commons-dbcp2:$version_apache_commons_dbcp2"

                implementation "org.nanohttpd:nanohttpd:$version_nanohttpd"
                implementation "org.nanohttpd:nanohttpd-nanolets:$version_nanohttpd"

                api project(":sharedse")
                api project(":lib-room-annotations")
                api project(":lib-database-annotations")
            }
        }
        androidMain {
            dependencies {
                implementation "com.github.aakira:napier-android:$version_napier"
                implementation "com.android.support:appcompat-v7:$version_android_support_lib"
                implementation "com.android.support:support-v4:$version_android_support_lib"
                implementation "com.soywiz:klock-android:$version_klock"
                implementation "androidx.room:room-runtime:$version_android_room"
                implementation "androidx.paging:paging-runtime:$version_androidx_paging"

            }
            dependsOn commonJvmMain
        }
        jsMain {
            dependencies {
                implementation "org.jetbrains.kotlin:kotlin-stdlib-js:$version_kotlin"
                implementation "com.ustadmobile.kmpxmlpullparser:KMPXmlPullParser-js:$version_kmp"
                implementation "org.jetbrains.kotlinx:kotlinx-serialization-runtime-js:$version_kotlinx_serialization"
                implementation "com.soywiz:klock-js:$version_klock"
                implementation "com.github.aakira:napier-js:$version_napier"
                implementation "io.ktor:ktor-client-js:$version_ktor"
                implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core-js:$version_coroutines"


            }
        }

    }
}

ext.buildConfigProperties = new Properties()
ext.buildConfigProperties.load(new FileInputStream(rootProject.file("buildconfig.default.properties")))
if (rootProject.file("buildconfig.local.properties").exists()) {
    ext.buildConfigProperties.load(new FileInputStream(rootProject.file("buildconfig.local.properties")))
}

/*
 * Generate a class with constant integer flags for each string message ID. See localization docs
 * for further information.
 */
task prepareLocale {
    inputs.files(fileTree(dir: rootProject.file("locale")).matching { include '*.xml' })
    File outFile = project.file("src/commonMain/kotlin/com/ustadmobile/core/generated/locale/MessageID.kt")
    outFile.text = ''
    outFile << 'package com.ustadmobile.core.generated.locale\n\n'
    outFile << '/** DO NOT EDIT. GENERATED CODE */\n'
    outFile << 'object MessageID{\n\n'
    outFile << '    const val  NAME = "' + project.ext.buildConfigProperties['appName'] + '"\n\n'

    Map<String, Integer> messageIds = new HashMap<>()
    AtomicInteger messageIdGenerator = new AtomicInteger(2000)

    rootProject.fileTree(dir: "core/locale/main/values", include: "*.xml").each() { File file ->
        def xmlDoc = new XmlSlurper().parseText(file.getText("UTF-8"))
        xmlDoc.string.each() { str ->
            String msgName = str.@name

            if (!messageIds.containsKey(msgName)) {
                Integer value;
                if (str.attributes().get("value") != null) {
                    value = new Integer(str.attributes().get("value"))
                } else {
                    value = new Integer(messageIdGenerator.getAndIncrement())
                }

                messageIds.put(msgName, value)
            }
        }
    }

    Iterator<String> nameIterator = messageIds.keySet().iterator()

    while (nameIterator.hasNext()) {
        String strName = nameIterator.next()
        Integer value = messageIds.get(strName)
        outFile << '    const val ' + strName + ' = ' + String.valueOf(value) + '\n\n'
    }
    outFile << '}'
}

publishing {
    publications {
        maven(MavenPublication) {
            groupId rootProject.group
            artifactId project.name
            version rootProject.version
        }
    }

    repositories {
        maven {
            url rootProject.ext.buildConfigProperties['repo.dir']
        }
    }
}


/*
 * Added to overcome limitation on Android studio as per:
 *  http://tools.android.com/knownissues#TOC-JUnit-tests-missing-resources-in-classpath-when-run-from-Studio
 */
/*task copyTestResources(type: Copy) {
   from "${projectDir}/src/test/resources"
   from "${projectDir}/src/main/assets"
   from "${projectDir}/../core-tests/src/main/resources"
   into "${buildDir}/classes/test"
}
processTestResources.dependsOn copyTestResources */
